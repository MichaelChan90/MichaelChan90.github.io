<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#0078E7"><meta name="author" content="Michael Chan"><meta name="copyright" content="Michael Chan"><meta name="generator" content="Hexo 6.3.0"><meta name="theme" content="hexo-theme-yun"><title>tomcat安全加固 | MichaelChan Blog</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/star-markdown-css@0.4.1/dist/yun/yun-markdown.min.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/prism-theme-vars/base.css"><script src="https://fastly.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>function initScrollReveal() {
  [".post-card",".markdown-body img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
}
document.addEventListener("DOMContentLoaded", initScrollReveal);
document.addEventListener("pjax:success", initScrollReveal);
</script><link rel="icon" type="image/svg+xml" href="/favicon.svg"><link rel="mask-icon" href="/favicon.svg" color="#0078E7"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><link rel="preconnect" href="https://fastly.jsdelivr.net/npm/" crossorigin><script id="yun-config">
    window.Yun = {}
    window.CONFIG = {"hostname":"michaelchan90.github.io","root":"/","title":"星无尘的博客","version":"1.10.9","mode":"auto","copycode":true,"page":{"isPost":true},"i18n":{"placeholder":"搜索...","empty":"找不到您查询的内容: ${query}","hits":"找到 ${hits} 条结果","hits_time":"找到 ${hits} 条结果（用时 ${time} 毫秒）"},"anonymous_image":"https://cdn.yunyoujun.cn/img/avatar/none.jpg","say":{"api":"https://v1.hitokoto.cn","hitokoto":true},"local_search":{"path":"/search.xml"},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"fireworks":{"colors":null},"vendors":{"host":"https://fastly.jsdelivr.net/npm/","darken":"https://fastly.jsdelivr.net/npm/darken@1.5.0"}};
  </script><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script src="/js/hexo-theme-yun.js" type="module"></script><link rel="preconnect" href="https://www.google-analytics.com" crossorigin><script async src="https://www.googletagmanager.com/gtag/js?id=UA-164931119-1"></script><script>if (CONFIG.hostname === location.hostname) {
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-164931119-1');
}</script><script data-ad-client="ca-pub-9775647830683925" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(function(){
  var bp = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  if (curProtocol === 'https') {
    bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else {
    bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(bp, s);
})();</script><meta name="description" content="[toc] Tomcat结构Tomcat的初始目录结构： 12345678910111213&#x2F;usr&#x2F;local&#x2F;tomcat #主目录即安装的目录├── bin   #存放启动和关闭Tomcat的脚本文件├── conf  #存放Tomcat服务器的各种配置文件(后面单介绍)├── lib   #存放tomcat服务器支撑的jar包├── logs  #存放Tomcat的日志文件├── temp">
<meta property="og:type" content="article">
<meta property="og:title" content="tomcat安全加固">
<meta property="og:url" content="http://michaelchan90.github.io/2023/03/01/Tomcat%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA/index.html">
<meta property="og:site_name" content="MichaelChan Blog">
<meta property="og:description" content="[toc] Tomcat结构Tomcat的初始目录结构： 12345678910111213&#x2F;usr&#x2F;local&#x2F;tomcat #主目录即安装的目录├── bin   #存放启动和关闭Tomcat的脚本文件├── conf  #存放Tomcat服务器的各种配置文件(后面单介绍)├── lib   #存放tomcat服务器支撑的jar包├── logs  #存放Tomcat的日志文件├── temp">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://michaelchan90.github.io/picture/request_tomcat_jsp_flow.png">
<meta property="article:published_time" content="2023-03-01T11:57:36.000Z">
<meta property="article:modified_time" content="2023-03-13T08:55:30.341Z">
<meta property="article:author" content="Michael Chan">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://michaelchan90.github.io/picture/request_tomcat_jsp_flow.png"><script>(function() {
  if (CONFIG.mode !== 'auto') return
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches
  const setting = localStorage.getItem('darken-mode') || 'auto'
  if (setting === 'dark' || (prefersDark && setting !== 'light'))
    document.documentElement.classList.toggle('dark', true)
})()</script></head><body><script src="https://code.iconify.design/2/2.1.1/iconify.min.js"></script><script>// Define global variable
IconifyProviders = {
  // Empty prefix: overwrite default API provider configuration
  '': {
    // Use custom API first, use Iconify public API as backup
    resources: [
        'https://api.iconify.design',
    ],
    // Wait for 1 second before switching API hosts
    rotate: 1000,
  },
};</script><script defer src="https://fastly.jsdelivr.net/npm/animejs@latest"></script><script defer src="/js/ui/fireworks.js" type="module"></script><canvas class="fireworks"></canvas><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js" type="module"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="文章目录"><span class="icon iconify" data-icon="ri:list-ordered"></span></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="站点概览"><span class="icon iconify" data-icon="ri:passport-line"></span></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info mickey-mouse"><a class="site-author-avatar" href="/about/" title="Michael Chan"><img width="96" loading="lazy" src="https://cdn.jsdelivr.net/gh/michaelchan90/blog-imgbed/img/go.jpg" alt="Michael Chan"><span class="site-author-status" title="又是新的一天">🤔</span></a><div class="site-author-name"><a href="/about/">Michael Chan</a></div><a class="site-name" href="/about/site.html">MichaelChan Blog</a><sub class="site-subtitle">星无尘</sub><div class="site-description"></div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="主页"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:home-4-line"></span></span></a><div class="site-state-item"><a href="/archives/" title="归档(archives)"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:archive-line"></span></span><span class="site-state-item-count">19</span></a></div><div class="site-state-item"><a href="/categories/" title="分类(categories)"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:folder-2-line"></span></span><span class="site-state-item-count">13</span></a></div><div class="site-state-item"><a href="/tags/" title="标签(tags)"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:price-tag-3-line"></span></span><span class="site-state-item-count">3</span></a></div></nav><hr style="margin-bottom:0.5rem"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://github.com/michaelchan90" title="GitHub" target="_blank" style="color:#181717"><span class="icon iconify" data-icon="ri:github-line"></span></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="mailto:michaelchan90@outlook.com" title="E-Mail" target="_blank" style="color:#8E71C1"><span class="icon iconify" data-icon="ri:mail-line"></span></a></div><hr style="margin:0.5rem 1rem"><div class="links"><a class="links-item hty-icon-button" href="/links/" title="我的小伙伴们" style="color:dodgerblue"><span class="icon iconify" data-icon="ri:genderless-line"></span></a></div><br><a class="links-item hty-icon-button" id="toggle-mode-btn" href="javascript:;" title="Mode" style="color: #f1cb64"><span class="icon iconify" data-icon="ri:contrast-2-line"></span></a></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Tomcat%E7%BB%93%E6%9E%84"><span class="toc-number">1.</span> <span class="toc-text">Tomcat结构</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%86%85%E6%A0%B8%E4%BC%98%E5%8C%96"><span class="toc-number">2.</span> <span class="toc-text">内核优化</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98"><span class="toc-number">3.</span> <span class="toc-text">性能调优</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#JVM%E8%B0%83%E4%BC%98"><span class="toc-number">3.1.</span> <span class="toc-text">JVM调优</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#JVM%E7%8E%AF%E5%A2%83%E5%8F%82%E6%95%B0"><span class="toc-number">3.1.1.</span> <span class="toc-text">JVM环境参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JVM%E5%86%85%E5%AD%98%E8%B0%83%E4%BC%98"><span class="toc-number">3.1.2.</span> <span class="toc-text">JVM内存调优</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JVM%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E8%B0%83%E4%BC%98"><span class="toc-number">3.1.3.</span> <span class="toc-text">JVM垃圾回收调优</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Tomcat%E8%B0%83%E4%BC%98"><span class="toc-number">3.2.</span> <span class="toc-text">Tomcat调优</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Connector%E5%85%83%E7%B4%A0%E5%B1%9E%E6%80%A7%E4%BC%98%E5%8C%96%EF%BC%88service-xml%E9%85%8D%E7%BD%AE%EF%BC%89"><span class="toc-number">3.2.1.</span> <span class="toc-text">Connector元素属性优化（service.xml配置）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA"><span class="toc-number">4.</span> <span class="toc-text">安全加固</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BA%AB%E4%BB%BD%E9%89%B4%E5%88%AB"><span class="toc-number">4.1.</span> <span class="toc-text">身份鉴别</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6"><span class="toc-number">4.2.</span> <span class="toc-text">访问控制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E5%85%A8%E5%AE%A1%E8%AE%A1"><span class="toc-number">4.3.</span> <span class="toc-text">安全审计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B5%84%E6%BA%90%E6%8E%A7%E5%88%B6"><span class="toc-number">4.4.</span> <span class="toc-text">资源控制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A7%BB%E9%99%A4%E9%BB%98%E8%AE%A4%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F"><span class="toc-number">4.4.1.</span> <span class="toc-text">移除默认应用程序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%94%99%E8%AF%AF%E9%A1%B5%E9%9D%A2%E9%87%8D%E5%AE%9A%E5%90%91"><span class="toc-number">4.4.2.</span> <span class="toc-text">错误页面重定向</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%99%90%E5%88%B6%E8%AE%BF%E9%97%AETomcat%E6%96%87%E4%BB%B6%E5%A4%B9"><span class="toc-number">4.4.3.</span> <span class="toc-text">限制访问Tomcat文件夹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%9A%E8%AF%9D%E8%B6%85%E6%97%B6"><span class="toc-number">4.4.4.</span> <span class="toc-text">会话超时</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%A5%E4%BE%B5%E9%98%B2%E8%8C%83"><span class="toc-number">4.5.</span> <span class="toc-text">入侵防范</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%B2%E6%AD%A2%E7%BC%93%E6%85%A2%E7%9A%84http%E6%8B%92%E7%BB%9D%E6%9C%8D%E5%8A%A1%E6%94%BB%E5%87%BB%E4%B8%8E%E9%99%90%E5%88%B6%E7%9B%91%E5%90%AC%E7%BD%91%E7%BB%9C%E6%8E%A5%E5%8F%A3"><span class="toc-number">4.5.1.</span> <span class="toc-text">防止缓慢的http拒绝服务攻击与限制监听网络接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A6%81%E7%94%A8tomcat%E7%9A%84AJP%E5%8D%8F%E8%AE%AE%EF%BC%888-5-51%E4%B9%8B%E5%89%8D%E7%9A%84%E7%89%88%E6%9C%AC%E9%BB%98%E8%AE%A4%E5%BC%80%E5%90%AF%E5%90%8E%E7%BB%AD%E5%88%99%E7%A6%81%E7%94%A8%EF%BC%89"><span class="toc-number">4.5.2.</span> <span class="toc-text">禁用tomcat的AJP协议（8.5.51之前的版本默认开启后续则禁用）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A6%81%E7%94%A8%E9%9D%9E%E6%B3%95HTTP%E8%AF%B7%E6%B1%82%E6%96%B9%E6%B3%95"><span class="toc-number">4.5.3.</span> <span class="toc-text">禁用非法HTTP请求方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A6%81%E6%AD%A2%E7%9B%AE%E5%BD%95%E5%88%97%E5%87%BA"><span class="toc-number">4.5.4.</span> <span class="toc-text">禁止目录列出</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%B2%E6%AD%A2%E6%81%B6%E6%84%8F%E5%85%B3%E9%97%AD%E6%9C%8D%E5%8A%A1"><span class="toc-number">4.5.5.</span> <span class="toc-text">防止恶意关闭服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9Banner%E6%8E%A9%E7%9B%96%E7%9C%9F%E5%AE%9E%E4%BF%A1%E6%81%AF"><span class="toc-number">4.5.6.</span> <span class="toc-text">修改Banner掩盖真实信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E9%97%AD%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2"><span class="toc-number">4.5.7.</span> <span class="toc-text">关闭自动部署</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEHTTPS%E5%8A%A0%E5%AF%86%E5%8D%8F%E8%AE%AE"><span class="toc-number">4.5.8.</span> <span class="toc-text">配置HTTPS加密协议</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HttpOnly%E6%A0%87%E8%AE%B0"><span class="toc-number">4.5.9.</span> <span class="toc-text">HttpOnly标记</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CSRF%E9%98%B2%E6%8A%A4-%E6%A0%B9%E6%8D%AE%E5%AE%9E%E9%99%85%E6%83%85%E5%86%B5%E6%B7%BB%E5%8A%A0"><span class="toc-number">4.5.10.</span> <span class="toc-text">CSRF防护(根据实际情况添加)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%BB%98%E8%AE%A4%E8%AE%BE%E7%BD%AE"><span class="toc-number">4.5.11.</span> <span class="toc-text">默认设置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%AF%E9%80%89%E6%93%8D%E4%BD%9C"><span class="toc-number">4.6.</span> <span class="toc-text">可选操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Java-SecurityManager"><span class="toc-number">4.6.1.</span> <span class="toc-text">Java SecurityManager</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BF%E9%97%AEJava%E5%8C%85%E6%8E%A7%E5%88%B6"><span class="toc-number">4.6.2.</span> <span class="toc-text">访问Java包控制</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Server-xml%E7%94%9F%E4%BA%A7%E9%85%8D%E7%BD%AE%E5%AE%9E%E4%BE%8B"><span class="toc-number">4.7.</span> <span class="toc-text">Server.xml生产配置实例</span></a></li></ol></li></ol></div></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="hty-card post-block" itemscope itemtype="https://schema.org/Article" style="--smc-primary:#0078E7;"><link itemprop="mainEntityOfPage" href="http://michaelchan90.github.io/2023/03/01/Tomcat%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="Michael Chan"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="MichaelChan Blog"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">tomcat安全加固</h1><div class="post-meta"><div class="post-time" style="display:block"><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:calendar-line"></span></span> <time title="创建时间：2023-03-01 19:57:36" itemprop="dateCreated datePublished" datetime="2023-03-01T19:57:36+08:00">2023-03-01</time><span class="post-meta-divider">-</span><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:calendar-2-line"></span></span> <time title="修改时间：2023-03-13 16:55:30" itemprop="dateModified" datetime="2023-03-13T16:55:30+08:00">2023-03-13</time></div><span class="post-count"><span class="post-symbolcount"><span class="post-meta-item-icon" title="本文字数"><span class="icon iconify" data-icon="ri:file-word-line"></span></span> <span title="本文字数">10.1k</span><span class="post-meta-divider">-</span><span class="post-meta-item-icon" title="阅读时长"><span class="icon iconify" data-icon="ri:timer-line"></span></span> <span title="阅读时长">42m</span></span></span><span class="post-busuanzi"><span class="post-meta-divider">-</span><span class="post-meta-item-icon" title="阅读次数"><span class="icon iconify" data-icon="ri:eye-line"></span> <span id="busuanzi_value_page_pv"></span></span></span><div class="post-classify"><span class="post-category"> <span class="post-meta-item-icon" style="margin-right:3px;"><span class="icon iconify" data-icon="ri:folder-line"></span></span><span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category-item" href="/categories/Tomcat/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">Tomcat</span></a></span></span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body"><p>[toc]</p>
<h1 id="Tomcat结构"><a href="#Tomcat结构" class="headerlink" title="Tomcat结构"></a>Tomcat结构</h1><p>Tomcat的初始目录结构：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/tomcat #主目录即安装的目录</span><br><span class="line">├── bin   #存放启动和关闭Tomcat的脚本文件</span><br><span class="line">├── conf  #存放Tomcat服务器的各种配置文件(后面单介绍)</span><br><span class="line">├── lib   #存放tomcat服务器支撑的jar包</span><br><span class="line">├── logs  #存放Tomcat的日志文件</span><br><span class="line">├── temp  #存放Tomcat运行时产生的临时文件</span><br><span class="line">├── webapps #web应用虽在目录，即供外界访问的web资源的存放目录,就是Web发布目录</span><br><span class="line">│   ├── docs #帮助文档目录</span><br><span class="line">│   ├── examples #Servlet and JSP Examples案例目录</span><br><span class="line">│   ├── host-manager #主机管理目录</span><br><span class="line">│   ├── manager  #应用程序管理目录</span><br><span class="line">│   └── ROOT  #应用程序放置地址</span><br><span class="line">└── work #Tomcat的工作目录,存放jsp编译后产生的class文件</span><br></pre></td></tr></table></figure>



<p>Tomcat全局配置目录结构：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">├── catalina.policy #权限控制配置文件</span><br><span class="line">├── catalina.properties #Tomcat属性配置文件</span><br><span class="line">├── context.xml  #上下文配置文件（selinux）</span><br><span class="line">├── jaspic-providers.xml</span><br><span class="line">├── jaspic-providers.xsd</span><br><span class="line">├── logging.properties #日志log相关配置文件</span><br><span class="line">├── server.xml  #主配置文件(如修改监听端口,开启关闭额外的服务,设置网站根目录，虚拟主机，开启https等功能)</span><br><span class="line">├── tomcat-users.xml #manager-gui管理用户配置文件（Tomcat安装后生成的管理界面，该文件可开启访问）</span><br><span class="line">├── tomcat-users.xsd</span><br><span class="line">└── web.xml #Tomcat的servlet，servlet-mapping，filter，MIME等相关配置</span><br></pre></td></tr></table></figure>



<p>Tomcat WebApp目录结构：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">webAppName--- #-Web应用所在目录</span><br><span class="line">  |---- #html、jsp、css、js等文件，根目录下的文件外界可以直接访问</span><br><span class="line">  |---- #WEB-INF目录 (应用配置文件存放)</span><br><span class="line">    |---------classes目录 #(java类)</span><br><span class="line">    |---------lib目录  #(java类运行所需的jar包)</span><br><span class="line">    |---------conf目录 #(数据库以及其他配置文件存放目录)</span><br><span class="line">    |---------web.xml  #(web应用的配置文件)</span><br><span class="line">#注意:WEB-INF 这个目录下的文件外界无法直接访问，由web服务器负责调用</span><br></pre></td></tr></table></figure>



<p>Tomcat默认端口：</p>
<ul>
<li>8005:用于SHUTDOWN指令来关闭Tomcat时使用;</li>
<li>8009:用于Apache连接Tomcat时候专用端口采用AJP协议;</li>
<li>8080:用于HTTP协议远程访问端口即Web页面访问端口;</li>
</ul>
<h1 id="内核优化"><a href="#内核优化" class="headerlink" title="内核优化"></a>内核优化</h1><p>需要调整的内核参数</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt;&gt; /etc/sysctl.conf &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string"># cat /proc/sys/net/core/netdev_max_backlog</span></span><br><span class="line"><span class="string"># 默认值：1000</span></span><br><span class="line"><span class="string"># 作用：网卡设备将请求放入队列的长度</span></span><br><span class="line"><span class="string">net.core.netdev_max_backlog = 32768</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># cat /proc/sys/net/core/somaxconn</span></span><br><span class="line"><span class="string"># 默认值：128</span></span><br><span class="line"><span class="string"># 作用：已经成功建立连接的套接字将要进入队列的长度</span></span><br><span class="line"><span class="string">net.core.somaxconn = 32768</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># cat /proc/sys/net/core/rmem_default</span></span><br><span class="line"><span class="string"># 默认值：212992</span></span><br><span class="line"><span class="string"># 作用：默认的TCP数据接收窗口大小（字节）</span></span><br><span class="line"><span class="string">net.core.rmem_default = 8388608</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># cat /proc/sys/net/core/wmem_default</span></span><br><span class="line"><span class="string"># 默认值：212992</span></span><br><span class="line"><span class="string"># 作用：默认的TCP数据发送窗口大小（字节）</span></span><br><span class="line"><span class="string">net.core.wmem_default = 8388608</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># cat /proc/sys/net/core/rmem_max</span></span><br><span class="line"><span class="string"># 默认值：212992</span></span><br><span class="line"><span class="string"># 作用：最大的TCP数据接收窗口大小（字节）</span></span><br><span class="line"><span class="string">net.core.rmem_max = 16777216</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># cat /proc/sys/net/core/wmem_max</span></span><br><span class="line"><span class="string"># 默认值：212992</span></span><br><span class="line"><span class="string"># 作用：最大的TCP数据发送窗口大小（字节）</span></span><br><span class="line"><span class="string">net.core.wmem_max = 16777216</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># cat /proc/sys/net/ipv4/ip_local_port_range</span></span><br><span class="line"><span class="string"># 默认值：32768   61000</span></span><br><span class="line"><span class="string"># 作用：可用端口的范围</span></span><br><span class="line"><span class="string">net.ipv4.ip_local_port_range = 1024  65535</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># cat /proc/sys/net/ipv4/route/gc_timeout</span></span><br><span class="line"><span class="string"># 默认值 300</span></span><br><span class="line"><span class="string"># 作用：路由缓存刷新频率，当一个路由失败后多长时间跳到另一个路由</span></span><br><span class="line"><span class="string">net.ipv4.route.gc_timeout = 100</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># cat /proc/sys/net/ipv4/tcp_fin_timeout</span></span><br><span class="line"><span class="string"># 默认 60</span></span><br><span class="line"><span class="string"># 作用：表示如果套接字由本端要求关闭，这个参数决定了它保持在FIN-WAIT-2状态的时间</span></span><br><span class="line"><span class="string">net.ipv4.tcp_fin_timeout = 30 </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># cat /proc/sys/net/ipv4/tcp_keepalive_time </span></span><br><span class="line"><span class="string"># 默认值：7200</span></span><br><span class="line"><span class="string"># 作用：间隔多久发送1次keepalive探测包</span></span><br><span class="line"><span class="string">net.ipv4.tcp_keepalive_time = 1200  </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># cat /proc/sys/net/ipv4/tcp_timestamps </span></span><br><span class="line"><span class="string"># 默认值：1</span></span><br><span class="line"><span class="string"># 作用：TCP时间戳，时间戳必须要开启，否则下面的 TIME_WAIT 重用和快速回收无效</span></span><br><span class="line"><span class="string">net.ipv4.tcp_timestamps = 1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># cat /proc/sys/net/ipv4/tcp_tw_recycle</span></span><br><span class="line"><span class="string"># 默认值：0</span></span><br><span class="line"><span class="string"># 作用：表示开启TCP连接中TIME-WAIT sockets的快速回收，默认为0，表示关闭。</span></span><br><span class="line"><span class="string">net.ipv4.tcp_tw_recycle = 1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">######################## cat /proc/sys/net/ipv4/tcp_tw_reuse</span></span><br><span class="line"><span class="string"># 默认值：0</span></span><br><span class="line"><span class="string"># 作用：针对 TIME-WAIT，做为客户端可以启用（例如，作为nginx-proxy前端代理，要访问后端的服务）</span></span><br><span class="line"><span class="string">net.ipv4.tcp_tw_reuse = 1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># cat /proc/sys/net/ipv4/tcp_syn_retries</span></span><br><span class="line"><span class="string"># 默认值 2</span></span><br><span class="line"><span class="string"># 作用：在内核放弃建立连接之前发送SYN包的数量。</span></span><br><span class="line"><span class="string">net.ipv4.tcp_syn_retries = 1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># cat /proc/sys/net/ipv4/tcp_synack_retries</span></span><br><span class="line"><span class="string"># 默认值 2</span></span><br><span class="line"><span class="string"># 作用：为了打开对端的连接，内核需要发送一个SYN并附带一个回应前面一个SYN的ACK。也就是所谓三次握手中的第二次握手。这个设置决定了内核放弃连接之前发送SYN+ACK包的数量。</span></span><br><span class="line"><span class="string">net.ipv4.tcp_synack_retries = 1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># cat /proc/sys/net/ipv4/tcp_mem</span></span><br><span class="line"><span class="string">#确定 TCP 栈应该如何反映内存使用；每个值的单位都是内存页（通常是 4KB）。</span></span><br><span class="line"><span class="string">#第一个值是内存使用的下限。</span></span><br><span class="line"><span class="string">#第二个值是内存压力模式开始对缓冲区使用应用压力的上限。</span></span><br><span class="line"><span class="string">#第三个值是内存上限。在这个层次上可以将报文丢弃，从而减少对内存的使用。对于较大的 BDP 可以增大这些值（但是要记住，其单位是内存页，而不是字节）。</span></span><br><span class="line"><span class="string">net.ipv4.tcp_mem = 94500000    915000000   927000000</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># cat /proc/sys/net/ipv4/tcp_max_orphans</span></span><br><span class="line"><span class="string"># 默认值 16384</span></span><br><span class="line"><span class="string"># 作用：系统中最多有多少个TCP套接字不被关联到任何一个用户文件句柄上。如果超过这个数字，孤儿连接将即刻被复位并打印出警告信息。这个限制仅仅是为了防止简单 的DoS攻击，你绝对不能过分依靠它或者人为地减小这个值，更应该增加这个值(如果增加了内存之后)。</span></span><br><span class="line"><span class="string">net.ipv4.tcp_max_orphans = 3276800</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># cat /proc/sys/net/ipv4/tcp_max_syn_backlog</span></span><br><span class="line"><span class="string"># 默认值：128</span></span><br><span class="line"><span class="string"># 作用：增大SYN队列的长度，容纳更多连接</span></span><br><span class="line"><span class="string">net.ipv4.tcp_max_syn_backlog = 65535</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="comment">#执行使内核参数生效</span></span><br><span class="line">sysctl -p</span><br></pre></td></tr></table></figure>









<h1 id="性能调优"><a href="#性能调优" class="headerlink" title="性能调优"></a>性能调优</h1><h2 id="JVM调优"><a href="#JVM调优" class="headerlink" title="JVM调优"></a>JVM调优</h2><h3 id="JVM环境参数"><a href="#JVM环境参数" class="headerlink" title="JVM环境参数"></a>JVM环境参数</h3><table>
<thead>
<tr>
<th align="left">参数</th>
<th align="left">描述</th>
<th align="left">备注</th>
</tr>
</thead>
<tbody><tr>
<td align="left">-server</td>
<td align="left">Server 模式启动应用慢但是极大程度提高运行性能，特别是在稳定期过后。</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">-client</td>
<td align="left">Cliet  模式启动应用快。</td>
<td align="left">JVM默认使用该模式</td>
</tr>
</tbody></table>
<h3 id="JVM内存调优"><a href="#JVM内存调优" class="headerlink" title="JVM内存调优"></a>JVM内存调优</h3><table>
<thead>
<tr>
<th>参数</th>
<th>描述说明</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>-Xms</td>
<td>堆的初始可用内存大小，单位（m、g）</td>
<td>-Xms2g</td>
</tr>
<tr>
<td>-Xmx</td>
<td>堆的最大可用内存大小，单位（m、g）</td>
<td>-Xms8g<br/>设置与Xms相同的内存大小 , 为减少程序运行时进行的垃圾回收次数和空间扩展</td>
</tr>
<tr>
<td>-Xmn</td>
<td>设置年轻代内存大小，单位(m、g)</td>
<td>-Xmn256m</td>
</tr>
<tr>
<td>-Xss</td>
<td>设置每个线程的栈Stack大小，单位（m、g）</td>
<td>-Xss128k<br/>越大我们能递归调用的方法数量越多，但是空间越大创建时间越长</td>
</tr>
<tr>
<td>-XX:NewRatio</td>
<td>设置年轻代（Eden区与两个Survivor区）与老年代的比值</td>
<td>-XX:NewRatio&#x3D;4</td>
</tr>
<tr>
<td>-XX:SurvivorRatio</td>
<td>设置Eden区与一个Survior区的大小比值</td>
<td>-XX:SurvivorRatio&#x3D;4</td>
</tr>
<tr>
<td>-XX:PermSize</td>
<td>设置持久代大小为16m, 持久代一般固定的内存大小为64m。</td>
<td>JDK8.0后被删除</td>
</tr>
<tr>
<td>-XX:MaxPermSize</td>
<td>设置最大持久代大小为16m, 默认是物理内存的1&#x2F;4最大1024m。</td>
<td>JDK8.0后被删除</td>
</tr>
<tr>
<td>-XX:MaxTenuringThreshold</td>
<td>设置垃圾最大年龄存活</td>
<td>如果设置为0的话则年轻代对象不经过Survivor区，直接进入年老代, 对于年老代比较多的应用可以提高效率。 <br/>如果将此值设置为一个较大值，则年轻代对象会在Survivor区进行多次复制，这样可以增加对象再年轻代的存活时间，增加在年轻代即被回收的概论。</td>
</tr>
</tbody></table>
<h3 id="JVM垃圾回收调优"><a href="#JVM垃圾回收调优" class="headerlink" title="JVM垃圾回收调优"></a>JVM垃圾回收调优</h3><table>
<thead>
<tr>
<th>垃圾回收器</th>
<th>描述说明</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>-XX:+UseSerialGc</td>
<td><strong>串行垃圾回收</strong>：即在整个扫描和复制过程采用单线程的方式来进行，适用于单CPU、新生代空间较小及对暂停时间要求不是非常高的应用上，是client级别默认的GC方式，主要在JDK1.5之前的垃圾回收方式。</td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>-XX:+UseParallelGC</td>
<td><strong>并行垃圾回收</strong>：即在整个扫描和复制过程采用多线程的方式来进行，适用于多CPU、对暂停时间要求较短的应用上，是server级别默认采用的GC方式。此配置仅对年轻代有效。该配置只能让年轻代使用并发收集，而年老代仍旧使用串行收集。</td>
<td></td>
</tr>
<tr>
<td>-XX:ParallelGCThreads&#x3D;4</td>
<td>配置并行收集器(Gc)的线程数，即：同时多少个线程一起进行垃圾回收。此值最好配置与处理器数目相等。</td>
<td></td>
</tr>
<tr>
<td>-XX:+UseParallelGCThreads&#x3D;8</td>
<td>并行收集器线程数同时有多少个线程进行垃圾回收一般与CPU数量相等</td>
<td>JDK8后被删除</td>
</tr>
<tr>
<td>-XX:+UseParallelOldGC</td>
<td>配置年老代垃圾收集方式为并行收集, JDK6.0支持对年老代并行收集。</td>
<td></td>
</tr>
<tr>
<td>-XX:MaxGCPauseMillis</td>
<td>设置每次年轻代垃圾回收的最长时间，如果无法满足此时间，JVM会自动调整年轻代大小，以满足此值。</td>
<td>-XX:MaxGCPauseMillis&#x3D;100</td>
</tr>
<tr>
<td>-XX:+UseAdaptiveSizePolicy</td>
<td>设置此选项后，并行收集器会自动选择年轻代区大小和相应的Survivor区比例，以达到目标系统规定的最低相应时间或者收集频率等，此值建议使用并行收集器时一直打开。</td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>-XX:+UseConcMarkSweepGC</td>
<td>代表垃圾回收策略为并发收集器</td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>-XX:PrintGC</td>
<td>每次触发GC的时候打印相关日志</td>
<td></td>
</tr>
<tr>
<td>-XX:+PrintGCDetails</td>
<td>更详细的GC日志</td>
<td></td>
</tr>
<tr>
<td>-XX:+HeapDumpOnOutOfMemoryError</td>
<td>堆异常报错输出</td>
<td></td>
</tr>
<tr>
<td>-XX:HeapDumpPath</td>
<td>设置在dump heap时将文件dump到哪里。默认是当前目录下 java_pidpid.hprof这样形式的文件。</td>
<td>-XX:HeapDumpPath&#x3D;path</td>
</tr>
<tr>
<td>-XX:+UseCMSCompactAtFullCollection</td>
<td>开启内存空间压缩和整理，防止过多内存碎片</td>
<td></td>
</tr>
<tr>
<td>-Djava.awt.headless</td>
<td>windows系统可不用设置,适用于Linux系统与图形操作有关，如生成验证码含义是当前的是无显示器的服务器，应用中如果获取系统显示有关的参数会抛出异常</td>
<td></td>
</tr>
<tr>
<td>-Dfile.encoding&#x3D;UTF-8</td>
<td>设置字符集避免日志中出现乱码</td>
<td></td>
</tr>
<tr>
<td>-Dsun.jnu.encoding</td>
<td>设置字符集避免日志中出现乱码</td>
<td></td>
</tr>
<tr>
<td>-Duser.timezone</td>
<td>时区设置</td>
<td></td>
</tr>
</tbody></table>
<p>配置示例</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Linux#</span></span><br><span class="line"><span class="attr">$vim</span> <span class="string">/usr/local/tomcat8/bin/catalina.sh</span></span><br><span class="line"><span class="comment">#在OS specific support. $var _must_ be set to either true or false.110行下面添加</span></span><br><span class="line"><span class="attr">JAVA_OPTS</span>=<span class="string">&quot;-server </span></span><br><span class="line"><span class="attr">-Xms1024m</span> <span class="string"></span></span><br><span class="line"><span class="attr">-Xmx1024m</span> <span class="string"></span></span><br><span class="line"><span class="attr">-Xmn256m</span></span><br><span class="line"><span class="attr">-XX</span>:<span class="string">NewRatio=4</span></span><br><span class="line"><span class="attr">-XX</span>:<span class="string">SurvivorRatio=4</span></span><br><span class="line"><span class="attr">-XX</span>:<span class="string">+UseParallelGC</span></span><br><span class="line"><span class="attr">-XX</span>:<span class="string">ParallelGCThreads=4</span></span><br><span class="line"><span class="attr">-XX</span>:<span class="string">+UseParallelOldGC </span></span><br><span class="line"><span class="attr">-XX</span>:<span class="string">+UseParallelOldGC</span></span><br><span class="line"><span class="attr">&quot;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#Windows#</span></span><br><span class="line"><span class="attr">$vim</span> <span class="string">/usr/local/tomcat8/bin/catalina.bat</span></span><br><span class="line"><span class="comment">#在/bin目录下的catalina.bat可以直接通过Tomcat设置JVM内存参数</span></span><br><span class="line"><span class="attr">set</span> <span class="string">&quot;JAVA_OPTS=%JAVA_OPT% -server -Xms2048m -Xmx2048m -XX:PermSize=256m -XX:MaxPermSize=512m -Djava.awt.headless=true&quot;</span></span><br></pre></td></tr></table></figure>



<p><em>注意事项:</em></p>
<ul>
<li>java 8开始<code>PermSize</code>被<code>MetaspaceSize</code>代替，MetaspaceSize共享heap不会再有<code>java.lang.OutOfMemoryError：PermGen space</code>可以不设置</li>
<li>java8 开始已经移除<code>MaxPermSize/UseParallelGCThreads=8</code></li>
<li>Java 提供的垃圾回收机制虚拟机的堆大小决定了虚拟机花费在收集垃圾上的时间和频度并且收集垃圾可以接受的速度与应用有关<ul>
<li>如果堆(heap)的空间很大，那么完全垃圾收集（FULL GC）就会很慢，但是频度会降低。</li>
<li>如果在客户系统中把堆的大小和内存的需要一致，完全收集就很快，但是会更加频繁。</li>
<li><code>推荐把-Xms设置为应用所需的最小值，这样会产生高效的垃圾回收</code>。</li>
</ul>
</li>
</ul>
<h2 id="Tomcat调优"><a href="#Tomcat调优" class="headerlink" title="Tomcat调优"></a>Tomcat调优</h2><p>虽然tomcat也可以作web服务器但其处理静态html的速度比不上Nginx服务,并且为了更好的进行设置负载均衡,还是得和Nginx进行联用;</p>
<p>因此我们可以把 Nginx 和 Tomcat 集成起来, 将html与jsp的功能部分进行明确分工, 让tomcat只处理jsp部分，或者也可以由其它的由 apache, IIS 等这些 web服务器处理，由此大大节省了tomcat有限的工作线程。</p>
<h3 id="Connector元素属性优化（service-xml配置）"><a href="#Connector元素属性优化（service-xml配置）" class="headerlink" title="Connector元素属性优化（service.xml配置）"></a>Connector元素属性优化（service.xml配置）</h3><ol>
<li>特殊配置详解</li>
</ol>
<ul>
<li><p>禁用DNS查询</p>
<ul>
<li><p>优化：<code>enableLookups=&quot;false&quot;</code></p>
</li>
<li><p>描述：除DNS查询对性能的影响我们可以关闭DNS查询</p>
</li>
<li><p>结果：节省了网络带宽、查询时间和内存，而且更小的流量会使日志数据也会变得更少，显而易见也节省了硬盘空间</p>
</li>
</ul>
</li>
<li><p>调整线程数</p>
<ul>
<li>优化： 修改 <code>minProcessors</code> 和<code>maxProcessors</code> 的值来控制线程数</li>
<li>描述：可通过应用程序的连接器（Connector）进行性能控制的参数是创建的处理请求的线程数。在Java中线程是程序运行时的路径，是在一个程序中与其它控制线程无关的、能够独立运行的代码段。但是应防止流量不可控制（或者恶意的服务攻击），从而导致超出了虚拟机使用内存的大小；web server允许的最大连接数还受制于操作系统的内核参数设置，通常Windows是2000个左右，Linux是1000个左右。</li>
<li>结果：它们共享相同的地址空间。多线程帮助程序员写出CPU最大利用率的高效程序，使空闲时间保持最低，从而接受更多的请求。</li>
</ul>
</li>
<li><p>NIO配置</p>
<ul>
<li>优化：<code>protocol=&quot;org.apache.coyote.http11.Http11NioProtocol&quot;</code></li>
<li>描述:NIO （No-blocking I&#x2F;O）从JDK 1.4起，NIO API作为一个基于缓冲区，并能提供非阻塞I&#x2F;O操作的API被引入[LD6];TOMCAT可以支持高并发的企业级应用,配置良好的tomcat都会使用APR(Apache Portable Runtime),APR是Apache HTTP Server2.x的核心，它是高度可移植的本地库，它使用高性能的UXIN I&#x2F;O操作，低性能的java io操作。</li>
<li>结果：NIO使用单线程(单个CPU)或者只使用少量的多线程(多CPU)来接受Socket，而由线程池来处理堵塞在pipe或者队列里的请求。只要OS可以接受TCP的连接，web服务器就可以处理该请求。大大提高了web服务器的可伸缩性。</li>
</ul>
</li>
<li><p>ARP配置</p>
<ul>
<li>优化：<code>protocol=&quot;org.apache.coyote.http11.Http11AprProtocol&quot;</code></li>
<li>描述：Tomcat APR 模式也是 Tomcat 在高并发下的首选运行模式</li>
<li>结果：调用 httpd 核心链接库来读取或文件传输，从而提高 tomcat 对静态文件的处理性能</li>
</ul>
</li>
</ul>
<ol start="2">
<li><p>其他属性详解</p>
<table>
<thead>
<tr>
<th>Connector属性</th>
<th>说明</th>
<th>默认值</th>
</tr>
</thead>
<tbody><tr>
<td>port</td>
<td>Tomcat启动监听端口</td>
<td>Default 8080</td>
</tr>
<tr>
<td>protocol</td>
<td>Tomcat的3种运行状态协议</td>
<td>Default bio HTTP&#x2F;1.1</td>
</tr>
<tr>
<td>acceptCount</td>
<td>监听端口队列最大数，满了之后客户请求会被拒绝（不能小于maxSpareThreads）</td>
<td>Default 100，建议设置1000</td>
</tr>
<tr>
<td>maxThreads</td>
<td>当前可以同时处理的最大用户访问数最大连接数配置（并发能力）</td>
<td>Default 200 ，建议设置1000</td>
</tr>
<tr>
<td>minSpareThreads</td>
<td>Tomcat初始化时创建的socket线程数，线程的最小运行数目</td>
<td>Default 10 ，建议设置1000</td>
</tr>
<tr>
<td>maxSpareThreads</td>
<td>Tomcat连接器的最大空闲socket线程数,一旦创建的线程超过这个值将会关闭socket</td>
<td>建议设置1000</td>
</tr>
<tr>
<td>minProcessors</td>
<td>服务器创建时的最小处理线程数</td>
<td>建议设置 100</td>
</tr>
<tr>
<td>maxProcessors</td>
<td>服务器同时最大处理线程数</td>
<td>建议设置 1000</td>
</tr>
<tr>
<td>enableLookups</td>
<td>支持域名解析可把ip地址解析为主机名</td>
<td>建议设置false 关闭DNS反向查询</td>
</tr>
<tr>
<td>compression</td>
<td>是否打开压缩功能</td>
<td>on</td>
</tr>
<tr>
<td>compressionMinSize</td>
<td>压缩的最小字节</td>
<td>2048</td>
</tr>
<tr>
<td>compressableMimeType</td>
<td>压缩的MImeType类型</td>
<td>text&#x2F;html,text&#x2F;xml,text&#x2F;javascript,text&#x2F;css,text&#x2F;plain</td>
</tr>
<tr>
<td>connectionTimeout</td>
<td>代表连接超时时间，单位为毫秒</td>
<td>默认值为60000。通常情况下设置为30000</td>
</tr>
<tr>
<td>disableUploadTimeout</td>
<td>标志允许servlet在一个servlet执行的时候，使用一个不同的更长的连接超时。</td>
<td>建议设为false</td>
</tr>
<tr>
<td>keepAliveTimeout</td>
<td>长连接超时时间</td>
<td>常常设置-1永不过期</td>
</tr>
<tr>
<td>URIEncoding</td>
<td>URL统一编码</td>
<td>utf-8</td>
</tr>
<tr>
<td>redirectPort</td>
<td>在需要基于安全通道的场合，把客户请求转发到基于SSL的redirectPort端口</td>
<td>8443</td>
</tr>
<tr>
<td>prestartminSpareThreads</td>
<td>在 Tomcat 初始化的时候就初始化 minSpareThreads 的</td>
<td></td>
</tr>
<tr>
<td>maxQueueSize</td>
<td>最大的等待队列数，超过则拒绝请求</td>
<td></td>
</tr>
</tbody></table>
<p>server.xml Connector配置详解</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">&lt;!‐‐ 将注释打开（注释没打开的情况下默认10个线程，最小10，最大200）‐‐&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">Executor</span> <span class="attr">name</span>=<span class="string">&quot;tomcatThreadPool&quot;</span> <span class="attr">namePrefix</span>=<span class="string">&quot;catalina‐exec‐&quot;</span> </span></span><br><span class="line"><span class="tag"><span class="attr">maxThreads</span>=<span class="string">&quot;500&quot;</span> <span class="attr">minSpareThreads</span>=<span class="string">&quot;50&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">prestartminSpareThreads</span>=<span class="string">&quot;true&quot;</span> <span class="attr">maxQueueSize</span>=<span class="string">&quot;100&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">Connector</span> </span></span><br><span class="line"><span class="tag"><span class="attr">port</span>=<span class="string">&quot;8080&quot;</span> </span></span><br><span class="line"><span class="tag">&lt;!‐‐ <span class="attr">默认BIO</span>/<span class="attr">建议采用NIO或者arp提高并发处理能力</span> <span class="attr">--</span>&gt;</span></span><br><span class="line">protocol=&quot;HTTP/1.1&quot;</span><br><span class="line"></span><br><span class="line">&lt;!‐‐ 网络连接超时，单位：毫秒。设置为0表示永不超时(不推荐)) --&gt;</span><br><span class="line">connectionTimeout=&quot;30000&quot;</span><br><span class="line">maxHttpHeaderSize=&quot;32768&quot;</span><br><span class="line">redirectPort=&quot;8443&quot;</span><br><span class="line"></span><br><span class="line">&lt;!‐‐ 当前可以同时处理的最大用户访问数最大连接数配置（并发能力） --&gt;</span><br><span class="line">maxThreads=&quot;1000&quot;</span><br><span class="line"></span><br><span class="line">&lt;!‐‐ Tomcat初始化时创建的线程数。最小空闲线程连接数用于优化线程池 --&gt;</span><br><span class="line">minSpareThreads=&quot;100&quot; </span><br><span class="line"></span><br><span class="line">&lt;!‐‐ 一旦创建的线程超过这个值，Tomcat就会关闭不再需要的socket线程。 --&gt;</span><br><span class="line">maxSpareThreads=&quot;1000&quot;</span><br><span class="line"></span><br><span class="line">acceptorThreadCount=&quot;2&quot; </span><br><span class="line"></span><br><span class="line">&lt;!‐‐ 当所有的线程以分配，仍然允许连接进来，但是出于等待状态的用户数。 --&gt;</span><br><span class="line">&lt;!‐‐ 等待线程数+工作线程数=总的可最大连接数,超过这个数的请求将不予处理。 --&gt;</span><br><span class="line">acceptCount=&quot;2000&quot;</span><br><span class="line">minProcessors=&quot;100&quot;</span><br><span class="line">maxProcessors=&quot;2000&quot;</span><br><span class="line"></span><br><span class="line">&lt;!‐‐ 为了消除DNS查询对性能的影响我们可以关闭DNS查询，关闭该功能在一定程度上提高了Tomcat服务器的性能; --&gt;</span><br><span class="line">enableLookups=&quot;false&quot;</span><br><span class="line">maxKeepAliveRequests=&quot;-1&quot;</span><br><span class="line">keepAliveTimeout=&quot;-1&quot;</span><br><span class="line">disableUploadTimeout=&quot;false&quot;</span><br><span class="line">connectionUploadTimeout=&quot;150000&quot;</span><br><span class="line">useSendfile=&quot;false&quot; </span><br><span class="line"></span><br><span class="line">&lt;!‐‐ Tomcat 压缩配置，建议在前端 nginx 上开启压缩。Tomcat 作为应用服务器本身就很繁忙了。--&gt;</span><br><span class="line">compression=&quot;on&quot;</span><br><span class="line">compressionMinSize=&quot;2048&quot;</span><br><span class="line">compressableMimeType=&quot;text/html,text/xml,application/javascript,application/json,text/javascript,text/css,text/plain,image/gif,image/png&quot;</span><br><span class="line">URIEncoding=&quot;UTF-8&quot; /&gt;</span><br></pre></td></tr></table></figure></li>
</ol>
<ol start="3">
<li><p>arp模式进行高并发选择</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1、现在arp源码包</span></span><br><span class="line"><span class="built_in">cd</span> /usr/local/src</span><br><span class="line">wget https://mirrors.tuna.tsinghua.edu.cn/apache/apr/apr-1.7.2.tar.gz</span><br><span class="line">wget https://mirrors.tuna.tsinghua.edu.cn/apache/apr/apr-util-1.6.3.tar.gz</span><br><span class="line"></span><br><span class="line">tar -zxvf apr-1.7.2.tar.gz &amp;&amp; tar -zxvf apr-util-1.6.3.tar.gz</span><br><span class="line"><span class="comment"># 2、编译安装</span></span><br><span class="line"><span class="built_in">cd</span> apr-1.7.2</span><br><span class="line">./configure --prefix=/usr/local/apr</span><br><span class="line">make -j 2 &amp;&amp; make install</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> apr-util-1.6.3</span><br><span class="line">./configure --prefix=/usr/local/apr-util --with-apr=/usr/local/apr/</span><br><span class="line">make -j2 &amp;&amp; make install</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3、添加apr path环境变量</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;export LD_LIBRARY_PATH=/usr/local/apr/lib&quot;</span> &gt; /etc/profile</span><br><span class="line"><span class="built_in">source</span> /etc/profile</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4、配置arp模式</span></span><br><span class="line">vi tomcat目录/conf/server.xml</span><br><span class="line"><span class="comment"># 设置文件内容如下</span></span><br><span class="line">&lt;Connector port=<span class="string">&quot;8080&quot;</span> protocol=<span class="string">&quot;org.apache.coyote.http11.Http11AprProtocol&quot;</span></span><br><span class="line">               connectionTimeout=<span class="string">&quot;20000&quot;</span></span><br><span class="line">               redirectPort=<span class="string">&quot;8443&quot;</span> /&gt;</span><br><span class="line"><span class="comment"># 注意如果SSLEngine设置off会导致报错</span></span><br><span class="line">&lt;Listener className=<span class="string">&quot;org.apache.catalina.core.AprLifecycleListener&quot;</span> SSLEngine=<span class="string">&quot;on&quot;</span> /&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 5、启动日志查看</span></span><br><span class="line"><span class="built_in">cat</span> apache-tomcat/logs/catalina.out</span><br><span class="line">12-Sep-2019 12:37:47.381 INFO [main] org.apache.coyote.AbstractProtocol.start Starting ProtocolHandler [<span class="string">&quot;http-apr-10.10.107.222-8080&quot;</span>]</span><br><span class="line">12-Sep-2019 12:37:47.417 INFO [main] org.apache.coyote.AbstractProtocol.start Starting ProtocolHandler [<span class="string">&quot;https-openssl-apr-443&quot;</span>]</span><br><span class="line">12-Sep-2019 12:37:47.419 INFO [main] org.apache.catalina.startup.Catalina.start Server startup <span class="keyword">in</span> 891 ms</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<ol start="4">
<li><p>启用外部连接池</p>
<p>描述：执行器（线程池）在tomcat中每一个用户请求都是一个线程，所以可以使用线程池提高性能。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 去掉下面两个元素注释并修改maxThreads： --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Executor</span> <span class="attr">name</span>=<span class="string">&quot;tomcatThreadPool&quot;</span> <span class="attr">namePrefix</span>=<span class="string">&quot;catalina-exec-&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">maxThreads</span>=<span class="string">&quot;300&quot;</span> <span class="attr">minSpareThreads</span>=<span class="string">&quot;4&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">Connector</span> <span class="attr">executor</span>=<span class="string">&quot;tomcatThreadPool&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">port</span>=<span class="string">&quot;8080&quot;</span> <span class="attr">protocol</span>=<span class="string">&quot;org.apache.coyote.http11.Http11NioProtocol&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">maxThreads</span>=<span class="string">&quot;1000&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">minSpareThreads</span>=<span class="string">&quot;100&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">maxSpareThreads</span>=<span class="string">&quot;200&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">acceptCount</span>=<span class="string">&quot;1000&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">disableUploadTimeout</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">connectionTimeout</span>=<span class="string">&quot;30000&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">URIEncoding</span>=<span class="string">&quot;UTF-8&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">enableLookups</span>=<span class="string">&quot;false&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">compression</span>=<span class="string">&quot;on&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">compressionMinSize</span>=<span class="string">&quot;2048&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">compressableMimeType</span>=<span class="string">&quot;text/html,text/xml,text/javascript,text/css,text/plain,image/gif,image/jpg,image/png&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">redirectPort</span>=<span class="string">&quot;8443&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>


</li>
<li><p>禁用自动检测更新加载</p>
<p>Context元素reloadable属性会监视在 <code>web-inf/classes</code> 和<code>web-inf/lib</code> 目录下class文件的改动，如果监测到有class文件被更新的，服务器会自动重新加载web应用。 </p>
<p>在开发和调试阶段,将其改为<code>true</code>但是一般像Eclipse等开发环境都会默认改为<code>true</code></p>
<p>在正式发布阶段，应将其该为<code>false</code>可以降低Tomcat的运行负荷，提高Tomcat的运行性能</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vi conf/server.xml</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在&lt;/Host&gt;之前加入类似以下内容：（重启生效）</span></span><br><span class="line">&lt;context path=<span class="string">&quot;/bbs&quot;</span> docbase=<span class="string">&quot;bbs&quot;</span>  reloadable=<span class="string">&quot;false&quot;</span>/&gt;</span><br></pre></td></tr></table></figure></li>
</ol>
<ol start="6">
<li><p>增大随机数熵池</p>
<p>描述：当你执行了 .&#x2F;startup.sh 或者 .&#x2F;catalina.sh start 后等待时间过长能要几分钟才能正常提供服务。 原因：在apache-tomcat 官方文档：如何让 tomcat 启动更快里面提到了一些启动时的优化项，其中一项是关于随机数生成时，采用的”熵源”(entropy source)的策略。</p>
<p>使用伪随机函数生成器:</p>
<ul>
<li>通过修改 Tomcat 启动文件 <code>-Djava.security.egd=file:/dev/urandom</code></li>
<li>通过修改 JRE 中的 <code>java.security</code> 文件 <code>securerandom.source=file:/dev/urand</code></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">JAVA_OPTS=<span class="string">&quot;-server -Xms1024m -Xmx2048m -XX:+UseConcMarkSweepGC -XX:CMSInitiatingOccupancyFraction=80 -XX:-PrintGC -XX:-PrintGCDetails -XX:-PrintGCTimeStamps  -Djava.security.egd=file:/dev/urandom&quot;</span></span><br></pre></td></tr></table></figure>

<p>增大&#x2F;dev&#x2F;random的熵池（推荐）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装熵池服务 rngd</span></span><br><span class="line">yum -y install rng-tools</span><br><span class="line">systemctl start rngd</span><br><span class="line">systemctl <span class="built_in">enable</span> rngd</span><br></pre></td></tr></table></figure>

<p>启动服务后观察 <code>cat/proc/sys/kernel/random/entropy_avail</code> 基本在三千左右。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /proc/sys/kernel/random/entropy_avail</span><br><span class="line">3311</span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="安全加固"><a href="#安全加固" class="headerlink" title="安全加固"></a>安全加固</h1><h2 id="身份鉴别"><a href="#身份鉴别" class="headerlink" title="身份鉴别"></a>身份鉴别</h2><ol>
<li><p>口令复杂度,不同用户不同账号</p>
<p>描述：口令要求：长度至少8位，并包括数字、小写字母、大写字母和特殊符号4类中至少3类。 修改tomcat配置文件&#x2F;conf&#x2F;tomcat-users.xml配置文件，要求usr1密码必须满足复杂度要求。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">user</span> <span class="attr">username</span>=<span class="string">&quot;Tomcat1&quot;</span> <span class="attr">password</span>=<span class="string">&quot;12345qwe&quot;</span> <span class="attr">roles</span>=<span class="string">&quot;manager-gui&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">user</span> <span class="attr">username</span>=<span class="string">&quot;Tomcat2&quot;</span> <span class="attr">password</span>=<span class="string">&quot;12345qwe&quot;</span> <span class="attr">roles</span>=<span class="string">&quot;admin-gui&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>


</li>
<li><p>安全配置manager登录页面并且删除多余账号</p>
<p>描述：Tomcat的主要管理界面被称为Manager应用程序</p>
<p>如果不使用manager来管理部署应用,建议修改tomcat配置文件<code>/conf/tomcat-users.xml</code>配置文件来禁用或者删除manager文件夹</p>
<p>如果使用该功能我们需要进行配置口令以及强密码包括访问控制,删除与工作无关的帐号以及应用。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#1.配置强密码登录manager后面</span></span><br><span class="line">vi tomcat_user.xml</span><br><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line">&lt;tomcat-users xmlns=<span class="string">&quot;http://tomcat.apache.org/xml&quot;</span></span><br><span class="line">              xmlns:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="line">              xsi:schemaLocation=<span class="string">&quot;http://tomcat.apache.org/xml tomcat-users.xsd&quot;</span></span><br><span class="line">              version=<span class="string">&quot;1.0&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">#角色如下并且要记得只赋予最小权限：</span></span><br><span class="line"><span class="comment"># manager-gui：可以访问web界面</span></span><br><span class="line"><span class="comment"># manager-status：只可以访问“Server Status”页面</span></span><br><span class="line"><span class="comment"># manager-script：可以脚本文本界面和“Server Status”页面</span></span><br><span class="line"><span class="comment"># manager-jmx：可以访问JMX代理界面和“Server Status”页面</span></span><br><span class="line">  &lt;role rolename=<span class="string">&quot;manager-gui&quot;</span>/&gt;</span><br><span class="line">  <span class="comment">#host-manager页面</span></span><br><span class="line">  &lt;role rolename=<span class="string">&quot;admin-gui&quot;</span>/&gt;</span><br><span class="line">  &lt;!--密码复杂度需要满足等保要求--&gt;</span><br><span class="line">  &lt;user username=<span class="string">&quot;admin&quot;</span> password=<span class="string">&quot;@weiyigeek@&quot;</span> roles=<span class="string">&quot;manager-gui,admin-gui&quot;</span>/&gt;</span><br><span class="line">&lt;/tomcat-users&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">#2.访问控制设定(其实默认只能本机访问)</span></span><br><span class="line">$/opt/tomcat/apache-tomcat-8.5.45/webapps/manager/META-INF/</span><br><span class="line"><span class="comment">#采用正则添加匹配</span></span><br><span class="line">&lt;Valve className=<span class="string">&quot;org.apache.catalina.valves.RemoteAddrValve&quot;</span> allow=<span class="string">&quot;127\.\d+\.\d+\.\d+|::1|0:0:0:0:0:0:0:1&quot;</span> /&gt;</span><br></pre></td></tr></table></figure>


</li>
<li><p>Tomcat虚拟主机管理器安全配置并且删除多余账号</p>
<p>描述：与manager管理一样如果使用的话进需要进行安全配置</p>
<p>不使用的话建议删除webapps应用目录下的<code>host-manager</code></p>
<p>使用需要进行安全配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#登录密码配置</span></span><br><span class="line">vi conf/tomcat-users.xml</span><br><span class="line">&lt;role rolename=<span class="string">&quot;admin-gui&quot;</span>/&gt;</span><br><span class="line">&lt;user username=<span class="string">&quot;tomcat&quot;</span> password=<span class="string">&quot;s3cret&quot;</span> roles=<span class="string">&quot;admin-gui&quot;</span>/&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">#访问配置(其实默认只能本机访问)</span></span><br><span class="line">&lt;Valve className=<span class="string">&quot;org.apache.catalina.valves.RemoteAddrValve&quot;</span> allow=<span class="string">&quot;127\.\d+\.\d+\.\d+|::1|0:0:0:0:0:0:0:1|10\.\d+\.\d+\.\d+&quot;</span> /&gt;</span><br></pre></td></tr></table></figure>


</li>
<li><p>非root启动服务</p>
<p>描述：建议使用专用用户 tomcat 或者 nobody 用户来启动 Tomcat，为了防止 Tomcat 被植入 web shell 程序后，可以修改项目文件。 因此我们要将 Tomcat 和项目的属主做分离（常常使upload目录可以有上传权限,但是不能有执行的权限）,他也无法创建和编辑项目文件。</p>
</li>
</ol>
<h2 id="访问控制"><a href="#访问控制" class="headerlink" title="访问控制"></a>访问控制</h2><p>描述：Tomcat提供了防止恶意攻击或禁止某些机器访问的设置，限制手段来防止恶意的服务攻击; 可以让你过滤来自请求的主机或IP地址，并允许或拒绝哪些主机&#x2F;IP。与之类似的在Apache的httpd文件里有对每个目录的允许&#x2F;拒绝指定。</p>
<p>1.Context.xml访问控制设置 Tomcat提供了两个参数供你配置：<code>RemoteHostValve</code> 和<code>RemoteAddrValve</code>。 例如: 你可以把Admin Web application设置成只允许本地访问设置如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Context</span> <span class="attr">path</span>=<span class="string">&quot;/path/to/secret_files&quot;</span> &gt;</span></span><br><span class="line"># 如果没有给出允许主机的指定，那么与拒绝主机匹配的主机就会被拒绝，除此之外的都是允许的</span><br><span class="line">  <span class="tag">&lt;<span class="name">Valve</span> <span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.valves.RemoteAddrValve&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">allow</span>=<span class="string">&quot;10.0.172.109&quot;</span> <span class="attr">deny</span>=<span class="string">&quot;&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Context</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h2 id="安全审计"><a href="#安全审计" class="headerlink" title="安全审计"></a>安全审计</h2><p><em>增加记录日志功能</em> </p>
<p>描述：Tomcat的日志文件存放于logs文件夹，里面包含了多种类型的日志，主要分为两类：</p>
<p>-<br>  一是运行中的日志，它主要记录运行的一些信息，尤其是一些异常错误日志信息。</p>
<ul>
<li>二是访问日志信息，它记录的访问的时间，IP，访问的资料等相关信息。</li>
</ul>
<p>各个日志文件的作用：</p>
<ul>
<li>localhost.2023-03-10.log：程序异常没有被捕获的时候抛出的地方</li>
<li>catalina.2023-03-10.log：程序的输出，tomcat的运行日志</li>
<li>manager.2023-03-10.log：manager项目专有的</li>
<li>host-manager.2023-03-10.log：manager项目专有的</li>
<li>localhost_access_log.2023-03-10.txt：访问日志记录</li>
</ul>
<p>编辑tomcat配置文件server.xml配置文件将以下内容的注释标记：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Access log processes all example.</span></span><br><span class="line"><span class="comment">            Documentation at: /docs/config/valve.html</span></span><br><span class="line"><span class="comment">            <span class="doctag">Note:</span> The pattern used is equivalent to using pattern=&quot;common&quot; --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Valve</span> <span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.valves.AccessLogValve&quot;</span> </span></span><br><span class="line"><span class="tag">    <span class="attr">directory</span>=<span class="string">&quot;logs&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">prefix</span>=<span class="string">&quot;localhost_access_log&quot;</span> <span class="attr">suffix</span>=<span class="string">&quot;.txt&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">pattern</span>=<span class="string">&quot;%h %l %u %t <span class="symbol">&amp;quot;</span>%r<span class="symbol">&amp;quot;</span> %s %b&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- </span></span><br><span class="line"><span class="comment">  每个字段的含义为</span></span><br><span class="line"><span class="comment">192.168.228.1 - - [29/Sep/2017:11:26:10 +0800] &quot;GET / HTTP/1.1&quot; 200 11418</span></span><br><span class="line"><span class="comment">%h：远程主机名或IP地址：192.168.228.1</span></span><br><span class="line"><span class="comment">%l：远程用户名，始终为“-”</span></span><br><span class="line"><span class="comment">%u：已验证的远程用户，如果没有则为“-”</span></span><br><span class="line"><span class="comment">%t：访问日期和时间：[29/Sep/2017:11:26:10 +0800]</span></span><br><span class="line"><span class="comment">%r：http请求中的第一行：GET / HTTP/1.1</span></span><br><span class="line"><span class="comment">%s：http状态码：200</span></span><br><span class="line"><span class="comment">%b：发送的字节数：11418</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br></pre></td></tr></table></figure>

<p>属性解释：</p>
<ul>
<li>Directory:日志文件放置的目录，在tomcat下面有个logs文件夹，那里面是专门放置日志文件的，也可以修改为其他路径；</li>
<li>Prefix:这个是日志文件的名称前缀，日志名称为localhost_access_log.2008-10-22.txt，前面的前缀就是这个localhost_access_log。</li>
<li>Suffix: 文件后缀名。</li>
<li>Pattern:common方式时，将记录访问源IP、本地服务器IP、记录日志服务器IP、访问方式、发送字节数、本地接收端口、访问URL地址等相关信息在日志文件中。</li>
<li>resolveHosts:值为true时，tomcat会将这个服务器IP地址通过DNS转换为主机名，如果是false，就直接写服务器IP地址。</li>
</ul>
<p>Tomcat的运行日志有以下7个级别：</p>
<blockquote>
<p> SEVERE &gt; WARNING &gt; INFO &gt; CONFIG &gt; FINE &gt; FINER &gt; FINEST  </p>
</blockquote>
<h2 id="资源控制"><a href="#资源控制" class="headerlink" title="资源控制"></a>资源控制</h2><h3 id="移除默认应用程序"><a href="#移除默认应用程序" class="headerlink" title="移除默认应用程序"></a>移除默认应用程序</h3><p>描述：Tomcat可能自带一些默认的web应用程序。如果不是一定需要，必须将它们移除。 移除${tomcat_home}&#x2F;webapps中所有的默认的web应用程序有：<code>ROOT、Documentation、Examples、Host Manager和Manager</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#如果不是一定需要，必须将它们移除。</span></span><br><span class="line"><span class="built_in">rm</span> -rf /opt/tomcat/apache-tomcat-8.5.45/webapps/*</span><br></pre></td></tr></table></figure>



<h3 id="错误页面重定向"><a href="#错误页面重定向" class="headerlink" title="错误页面重定向"></a>错误页面重定向</h3><p>描述：编辑tomcat配置文件&#x2F;conf&#x2F;web.xml文件,在最后一行之前加入以下内容,然后需要重新启动tomcat服务;</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">error-page</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 配置实现了将404未找到jsp网页的错误导向noFile.htm页面,还可以添加其多的错误代码导向页面，如403，500 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">error-code</span>&gt;</span>404<span class="tag">&lt;/<span class="name">error-code</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">location</span>&gt;</span>/noFile.htm<span class="tag">&lt;/<span class="name">location</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">error-page</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">error-page</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!--配置实现了当jsp网页出现java.lang.NullPointerException导常时，转向error.jsp错误页面 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">exception-type</span>&gt;</span>java.lang.NullPointerException<span class="tag">&lt;/<span class="name">exception-type</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">location</span>&gt;</span>/error.jsp<span class="tag">&lt;/<span class="name">location</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">error-page</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>当出现<code>NullPointerException</code>异常时tomcat会把网页导入到<code>error.jsp</code>，且会打印出出错信息。</p>
<figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ pageerrorPage=<span class="string">&quot;/error.jsp&quot;</span> %&gt;</span><br><span class="line">典型的error.jsp错误页面的程序写法如下:</span><br><span class="line">&lt;%@ pagecontentType=<span class="string">&quot;text/html;charset=GB2312&quot;</span>%&gt;</span><br><span class="line">&lt;%@ pageisErrorPage=<span class="string">&quot;true&quot;</span>%&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">  &lt;title&gt;错误页面&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line"></span><br><span class="line">&lt;body&gt;出错了：&lt;/p&gt;错误信息:&lt;%= exception.getMessage() %&gt;</span><br><span class="line">&lt;br&gt;</span><br><span class="line">Stack Trace is :</span><br><span class="line">  &lt;pre&gt;</span><br><span class="line">    &lt;font color=<span class="string">&quot;red&quot;</span>&gt;&lt;%</span><br><span class="line">    java.io.CharArrayWritercw = <span class="keyword">new</span> <span class="title class_">java</span>.io.CharArrayWriter();</span><br><span class="line">    java.io.PrintWriterpw = <span class="keyword">new</span> <span class="title class_">java</span>.io.PrintWriter(cw,<span class="literal">true</span>);</span><br><span class="line">    exception.printStackTrace(pw);</span><br><span class="line">    out.println(cw.toString());</span><br><span class="line">    %&gt;</span><br><span class="line">    &lt;/font&gt;</span><br><span class="line">  &lt;/pre&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>补充事项：</p>
<ul>
<li>如果Manager应用程序没被移除，必须手动将位于 <code>CATALINA_HOME/webapps/manager/WEB-INF/jsp/</code> 的错误页面里的Tomcat版本信息移除。</li>
</ul>
<h3 id="限制访问Tomcat文件夹"><a href="#限制访问Tomcat文件夹" class="headerlink" title="限制访问Tomcat文件夹"></a>限制访问Tomcat文件夹</h3><p>描述：Tomcat文件夹只能由tomcat用户本身访问，尤其是对于目录tomcathome&#x2F;conf&#x2F;和{tomcat_home}&#x2F;webapps当不需要通过应用程序服务器自动部署时，标准配置就是将所有Tomcat文件的所有者设置为root，并且所属群组设置为Tomcat,然后用chmod 740仅允许root用户编辑文件并允许Tomcat用户读取文件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#(注意点)例外是临时和工作目录的所有者应该是Tomcat用户而不是root用户。</span></span><br><span class="line"><span class="built_in">chown</span> root:tomcat /opt/tomcat</span><br><span class="line"><span class="built_in">chmod</span> 740 <span class="variable">$&#123;tomcat_home&#125;</span>/conf</span><br><span class="line"><span class="built_in">chmod</span> 740 <span class="variable">$&#123;tomcat_home&#125;</span>/webapp</span><br></pre></td></tr></table></figure>



<h3 id="会话超时"><a href="#会话超时" class="headerlink" title="会话超时"></a>会话超时</h3><p>描述：所有的web应用程序的会话超时必须设置为20分钟可通过编辑 <code>CATALINA_HOME/conf/web.xml</code> 文件并做以下配置来实现：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Tomcat8默认的超时时间是半个小时 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">session-config</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">session-timeout</span>&gt;</span>20<span class="tag">&lt;/<span class="name">session-timeout</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">session-config</span>&gt;</span></span><br></pre></td></tr></table></figure>





<h2 id="入侵防范"><a href="#入侵防范" class="headerlink" title="入侵防范"></a>入侵防范</h2><h3 id="防止缓慢的http拒绝服务攻击与限制监听网络接口"><a href="#防止缓慢的http拒绝服务攻击与限制监听网络接口" class="headerlink" title="防止缓慢的http拒绝服务攻击与限制监听网络接口"></a>防止缓慢的http拒绝服务攻击与限制监听网络接口</h3><p>描述：不要让连接器（connector）监听服务器上所有可用的网络接口和IP地址，而要让连接器监听指定的网络接口和IP地址采用address属性,防止应用程序意外地运行在某个开放的网络接口上。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#将默认值20000改成10000即可单位ms注意需要根据实际需求更改</span></span><br><span class="line">vi conf/server.xml</span><br><span class="line">&lt;Connector port=<span class="string">&quot;8080&quot;</span> protocol=<span class="string">&quot;HTTP/1.1&quot;</span> </span><br><span class="line">connectionTimeout=<span class="string">&quot;10000&quot;</span> </span><br><span class="line">redirectPort=<span class="string">&quot;8443&quot;</span> address=<span class="string">&quot;127.0.0.1&quot;</span> /&gt;</span><br></pre></td></tr></table></figure>



<h3 id="禁用tomcat的AJP协议（8-5-51之前的版本默认开启后续则禁用）"><a href="#禁用tomcat的AJP协议（8-5-51之前的版本默认开启后续则禁用）" class="headerlink" title="禁用tomcat的AJP协议（8.5.51之前的版本默认开启后续则禁用）"></a>禁用tomcat的AJP协议（8.5.51之前的版本默认开启后续则禁用）</h3><p>描述：AJP（Apache JServer Protocol）AJPv13协议是面向包的。 WEB服务器和Servlet容器通过TCP连接来交互, 为了节省SOCKET创建的昂贵代价，WEB服务器会尝试维护一个永久TCP连接到servlet容器，并且在多个请求和响应周期过程会重用连接。</p>
<p>实际上我们一般使用Nginx+Tomcat架构所以用不着Ajp协议可以将其禁用。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#  编辑server.xml进行注释配置</span></span><br><span class="line">vi conf/server.xml</span><br><span class="line">&lt;!-- &lt;Connector port=<span class="string">&quot;8009&quot;</span> protocol=<span class="string">&quot;AJP/1.3&quot;</span> redirectPort=<span class="string">&quot;8443&quot;</span> /&gt; --&gt;</span><br></pre></td></tr></table></figure>

<p><img src="/picture/request_tomcat_jsp_flow.png" alt="Web客户访问Tomcat服务器上的JSP组件的两种方式" loading="lazy"></p>
<h3 id="禁用非法HTTP请求方法"><a href="#禁用非法HTTP请求方法" class="headerlink" title="禁用非法HTTP请求方法"></a>禁用非法HTTP请求方法</h3><p>描述：readonly参数默认是true即不允许<code>delete</code>和<code>put</code>操作 </p>
<p>编辑<code>web.xml</code>文件查看<code>org.apache.catalina.servlets.DefaultServlet</code>是否存在如下配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim conf/web.xml</span><br><span class="line">&lt;init-param&gt;</span><br><span class="line">  &lt;param-name&gt;<span class="built_in">readonly</span>&lt;/param-name&gt;</span><br><span class="line">  &lt;param-value&gt;<span class="literal">true</span>&lt;/param-value&gt;</span><br><span class="line">&lt;/init-param&gt;</span><br></pre></td></tr></table></figure>



<h3 id="禁止目录列出"><a href="#禁止目录列出" class="headerlink" title="禁止目录列出"></a>禁止目录列出</h3><p>描述：设置<code>DefaultServlet</code>的<code>listings</code>为<code>false</code> 这不仅仅是因为允许显示目录列表被认为是不安全的，而且还因为生成具有数千个文件的目录列表会消耗大量的CPU资源，相当于被DDoS攻击。</p>
<p>注意：Tomcat8默认是false并且更改后需要重新启动tomcat服务;</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vi conf/web.xml</span><br><span class="line">&lt;!-- 同样也是在下面进行添加--&gt;</span><br><span class="line">&lt;servlet-class&gt;org.apache.catalina.servlets.DefaultServlet&lt;/servlet-class&gt;</span><br><span class="line">&lt;init-param&gt;</span><br><span class="line">  &lt;param-name&gt;listings&lt;/param-name&gt;</span><br><span class="line">  &lt;param-value&gt;<span class="literal">false</span>&lt;/param-value&gt;</span><br><span class="line">&lt;/init-param&gt;</span><br></pre></td></tr></table></figure>



<h3 id="防止恶意关闭服务"><a href="#防止恶意关闭服务" class="headerlink" title="防止恶意关闭服务"></a>防止恶意关闭服务</h3><p>描述：编辑tomcat配置文件conf&#x2F;server.xml配置文件，shutdown的值为复杂的字符串：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 随机生成密码</span></span><br><span class="line"><span class="variable">$cat</span> /dev/urandom | <span class="built_in">tr</span> -dc <span class="string">&#x27;_a-zA-Z0-9&#x27;</span> | <span class="built_in">head</span> -c 12</span><br><span class="line">r02BPRnHyq89</span><br><span class="line"><span class="comment"># 配置如下:将默认的SHUTDOWN变成r02BPRnHyq89</span></span><br><span class="line">&lt;Serverport=<span class="string">&quot;8005&quot;</span> shutdown=<span class="string">&quot;r02BPRnHyq89&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果不需要该功能，必须要将其停用，设置如下：</span></span><br><span class="line">&lt;Server  port=<span class="string">&quot;-1&quot;</span> shutdown=<span class="string">&quot;SHUTDOWN&quot;</span>&gt; <span class="comment"># 本地管理脚本可将服务器关闭，即使在关闭端口被禁用的情况下。</span></span><br></pre></td></tr></table></figure>



<h3 id="修改Banner掩盖真实信息"><a href="#修改Banner掩盖真实信息" class="headerlink" title="修改Banner掩盖真实信息"></a>修改Banner掩盖真实信息</h3><p>描述：修改以掩饰真实版本信息防止攻击者以版本的漏洞进行攻击,影响错误页面和响应头;</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (1)修改/lib/catalina.jar中org/apache/catalina/util/Serverinfo.properties问津中的以下参数 (推荐方式)</span></span><br><span class="line"><span class="comment"># 解压缩 catalina.jar</span></span><br><span class="line">vi catalina/org/apache/catalina/util/Serverinfo.properties</span><br><span class="line">server.info=Nginx</span><br><span class="line">server.number=0.0.0.0</span><br><span class="line">server.built=Apr 28 2023 07:25:00 UTC</span><br><span class="line"><span class="comment"># 将修改后的信息压缩回jar包</span></span><br><span class="line">jar uvf catalina.jar org/apache/catalina/util/ServerInfo.properties</span><br><span class="line"></span><br><span class="line"><span class="comment"># (2)修改web.xml中Connector链接器</span></span><br><span class="line">&lt;Connector port=<span class="string">&quot;8080&quot;</span> protocol=<span class="string">&quot;HTTP/1.1&quot;</span>  </span><br><span class="line">  connectionTimeout=<span class="string">&quot;20000&quot;</span> </span><br><span class="line">  redirectPort=<span class="string">&quot;8443&quot;</span>  </span><br><span class="line">  URIEncoding=<span class="string">&quot;UTF-8&quot;</span> </span><br><span class="line">  useBodyEncodingForURI=<span class="string">&quot;true&quot;</span> </span><br><span class="line">  server=<span class="string">&quot;Microsoft-IIS/6.5&quot;</span>/&gt;</span><br></pre></td></tr></table></figure>



<h3 id="关闭自动部署"><a href="#关闭自动部署" class="headerlink" title="关闭自动部署"></a>关闭自动部署</h3><p>描述：Tomcat允许在Tomcat运行时自动部署应用程序。为了防止被植入木马等恶意程序，因此我们要关闭自动部署。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vi server.xml</span><br><span class="line"><span class="comment">#将unpackWARs与autoDeploy的true值改成false;</span></span><br><span class="line">&lt;Host name=<span class="string">&quot;localhost&quot;</span>  appBase=<span class="string">&quot;webapps&quot;</span> unpackWARs=<span class="string">&quot;false&quot;</span> autoDeploy=<span class="string">&quot;false&quot;</span>&gt;</span><br></pre></td></tr></table></figure>

<p>在托管环境中Web应用程序可能不受信任，也可以设置<code>deployXML</code>属性为<code>false</code>来忽略<code>context.xml</code>以防给该web应用程序提高权限。</p>
<h3 id="配置HTTPS加密协议"><a href="#配置HTTPS加密协议" class="headerlink" title="配置HTTPS加密协议"></a>配置HTTPS加密协议</h3><p>描述：采用HTTPS协议加密可以防止中间人攻击,以及数据的拦截和修改的验证导致攻击无效;</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (1)用JDK自带的keytool工具生成一个证书,默认三个月的有效期;</span></span><br><span class="line"><span class="variable">$JAVA_HOME</span>/bin/keytool -genkey -<span class="built_in">alias</span> tomcat -keyalg RSA -keystore /tmp/keystore</span><br><span class="line">Enter keystore password:</span><br><span class="line">Re-enter new password:</span><br><span class="line">What is your first and last name?</span><br><span class="line">  [Unknown]:  Tomcat</span><br><span class="line">What is the name of your organizational unit?</span><br><span class="line">  [Unknown]:  CQ</span><br><span class="line">What is the name of your organization?</span><br><span class="line">  [Unknown]:  CQ</span><br><span class="line">What is the name of your City or Locality?</span><br><span class="line">  [Unknown]:  BEIJING</span><br><span class="line">What is the name of your State or Province?</span><br><span class="line">  [Unknown]:  XIZHIMEN</span><br><span class="line">What is the two-letter country code <span class="keyword">for</span> this unit?</span><br><span class="line">  [Unknown]:  408119</span><br><span class="line">Is CN=Tomcat, OU=CQ, O=CQ, L=BEIJING, ST=XIZHIMEN, C=408119 correct?</span><br><span class="line">  [no]:  Y</span><br><span class="line"></span><br><span class="line">Enter key password <span class="keyword">for</span> &lt;tomcat&gt;</span><br><span class="line">        (RETURN <span class="keyword">if</span> same as keystore password):</span><br><span class="line">Re-enter new password:</span><br><span class="line"></span><br><span class="line"><span class="comment"># (2)修改tomcat安装目录下/conf/server.xml配置文件，更改为使用HTTPS方式，增加如下行：</span></span><br><span class="line">&lt;Connector classname=<span class="string">&quot;org.apache.catalina.http.HttpConnector&quot;</span></span><br><span class="line">      port=<span class="string">&quot;443&quot;</span> protocol=<span class="string">&quot;HTTP/1.1&quot;</span>  minProcessors=<span class="string">&quot;5&quot;</span></span><br><span class="line">      SSLEnabled=<span class="string">&quot;true&quot;</span></span><br><span class="line">      maxprocessors=<span class="string">&quot;100&quot;</span></span><br><span class="line">      enableLookups=<span class="string">&quot;true&quot;</span> acceptCount=<span class="string">&quot;10&quot;</span>  debug=<span class="string">&quot;0&quot;</span></span><br><span class="line">      scheme=<span class="string">&quot;https&quot;</span></span><br><span class="line">      Factory_classname=<span class="string">&quot;org.apache.catalina.SSLServerSocketFactory&quot;</span></span><br><span class="line">      secure=<span class="string">&quot;true&quot;</span></span><br><span class="line">      clientAuth=<span class="string">&quot;false&quot;</span></span><br><span class="line">      keystoreFile=<span class="string">&quot;/tmp/keystore&quot;</span></span><br><span class="line">      keystorePass=<span class="string">&quot;weiyigeek&quot;</span></span><br><span class="line">      sslProtocol=<span class="string">&quot;TLS&quot;</span> /&gt;</span><br><span class="line"><span class="comment">#SSL Connector来指定可用的SSL加密方式：  </span></span><br><span class="line">ciphers=<span class="string">&quot;SSL_RSA_WITH_RC4_128_SHA, TLS_RSA_WITH_AES_128_CBC_SHA,  TLS_DHE_RSA_WITH_AES_128_CBC_SHA, TLS_DHE_DSS_WITH_AES_128_CBC_SHA,  SSL_RSA_WITH_3DES_EDE_CBC_SHA, SSL_DHE_RSA_WITH_3DES_EDE_CBC_SHA,  SSL_DHE_DSS_WITH_3DES_EDE_CBC_SHA&quot;</span></span><br></pre></td></tr></table></figure>

<p>补充：为了使托管在Tomcat上的所有web应用程序强制使用HTTPS，必须在每个 CATALINA_HOME&#x2F;webapps&#x2F;$WEBAPP&#x2F;WEB-INF&#x2F;web.xml 文件里每个security-constraint标签关闭（标签）之前包含以下内容：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">user-data-constraint</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">transport-guarantee</span>&gt;</span>CONFIDENTIAL<span class="tag">&lt;/<span class="name">transport-guarantee</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">user-data-constraint</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="HttpOnly标记"><a href="#HttpOnly标记" class="headerlink" title="HttpOnly标记"></a>HttpOnly标记</h3><p>描述：对会话cookie自动启用HttpOnly的cookie标记，查看配置以确保该选项为被禁用。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 要启用HttpOnly设置使之全局应用于所有应用程序：</span></span><br><span class="line">&lt;Context useHttpOnly=<span class="string">&#x27;true&#x27;</span>&gt;</span><br><span class="line">...</span><br><span class="line">&lt;Context&gt;</span><br></pre></td></tr></table></figure>

<p>补充：如果应用程序需要通过JavaScript访问HttpOnly cookie，可以在METAINF&#x2F;context.xml中一个单独的Context中定义一个异常。</p>
<h3 id="CSRF防护-根据实际情况添加"><a href="#CSRF防护-根据实际情况添加" class="headerlink" title="CSRF防护(根据实际情况添加)"></a>CSRF防护(根据实际情况添加)</h3><p>描述：为保护应用程序必须启用Tomcat的跨站请求伪造防护。Tomcat8~9提供了基本的CSRF防护。可以在 CATALINA_BASE&#x2F;conf&#x2F;web.xml 中配置一个全局过滤器。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#该过滤器可以被每个使用 WEB-INF/web.xml 文件的应用程序覆盖。</span></span><br><span class="line">&lt;filter-mapping&gt; </span><br><span class="line">  &lt;filter-name&gt;CSRFPreventionFilter&lt;/filter-name&gt;  </span><br><span class="line">  &lt;url-pattern&gt;/*&lt;/url-pattern&gt;  </span><br><span class="line">&lt;/filter-mapping&gt;</span><br></pre></td></tr></table></figure>

<p>补充：使用CSRF防护可能会影响程序功能，必须要牢记这一点，尤其是在应用程序大量使用异步请求的情况下。</p>
<h3 id="默认设置"><a href="#默认设置" class="headerlink" title="默认设置"></a>默认设置</h3><p>描述：以下是常规的默认配置并且默认情况下这些设置被认为是安全的,如有在项目中进行更改的建议进行整改和调整;</p>
<ol>
<li><p>server.xml中默认安全配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vi <span class="variable">$CATALINA_HOME</span>/conf/server.xml</span><br><span class="line">&lt;Connector</span><br><span class="line">  <span class="comment">#1.设置为空或者false</span></span><br><span class="line">  allowTrace=<span class="string">&quot;false&quot;</span> </span><br><span class="line">/&gt;</span><br></pre></td></tr></table></figure>




</li>
<li><p>context.xml中默认安全配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">vi <span class="variable">$CATALINA_HOME</span>/conf/server.xml</span><br><span class="line">&lt;Context </span><br><span class="line"><span class="comment">#1.将privileged属性设置为false，除非像Manager应用程序那样需要权限：</span></span><br><span class="line">privileged=<span class="string">&quot;false&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#2.确保crossContext值为空或被设为false,</span></span><br><span class="line"><span class="comment">#crossContext值为true可能会导致允许恶意应用程序向受限应用程序发送请求。</span></span><br><span class="line">crossContext=<span class="string">&quot;false&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#3.确保allowLinking值为空或被设为false。</span></span><br><span class="line"><span class="comment">#allowLinking值为true可能会导致目录遍历和源代码泄露漏洞的产生。</span></span><br><span class="line">allowLinking=<span class="string">&quot;false&quot;</span></span><br><span class="line">/&gt;</span><br></pre></td></tr></table></figure>




</li>
<li><p>Tomcat启动参数</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.当RECYCLE_FACADES选项设置为true时，Tomcat会回收请求间会话外观（session facade）,将导致请求间的信息泄漏</span></span><br><span class="line"><span class="comment"># 默认情况下，此参数未被设置(确保使用的启动脚本不包含以下内容)</span></span><br><span class="line">Dorg.apache.catalina.connector.RECYCLE_FACADES = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.允许在Tomcat上指定不同的路径分隔符，可能会允许攻击者访问应用程序，该行为本该被代理程序（比如mod_proxy）阻止</span></span><br><span class="line"><span class="comment"># 默认情况下，此参数未被设置(确保使用的启动脚本不包含以下内容)</span></span><br><span class="line">Dorg.apache.catalina.connector.CoyoteAdapter.ALLOW_BACKSLASH = FALSE</span><br><span class="line">Dorg.apache.tomcat.util.buf.UDecoder.ALLOW_ENCODED_SLASH = FALSE</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.允许自定义header状态消息，使攻击者也能够插header。</span></span><br><span class="line"><span class="comment"># 可能会导致XSS漏洞的产生。默认情况下此参数未被设置。</span></span><br><span class="line">Dorg.apache.coyote.USE_CUSTOM_STATUS_MSG_IN_HEADER = <span class="literal">false</span></span><br><span class="line">Dorg.apache.tomcat.util.buf.UDecoder.ALLOW_ENCODED_SLASH= FALSE</span><br><span class="line">Dorg.apache.coyote.USE_CUSTOM_STATUS_MSG_IN_HEADER = <span class="literal">false</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="可选操作"><a href="#可选操作" class="headerlink" title="可选操作"></a>可选操作</h2><h3 id="Java-SecurityManager"><a href="#Java-SecurityManager" class="headerlink" title="Java SecurityManager"></a>Java SecurityManager</h3><p>描述：可用Java  SecurityManager限制单个应用程序的功能。</p>
<ul>
<li><code>$CATALINA_HOME/conf/catalina.policy</code> 文件包含了<code>Java  SecurityManager</code>使用的安全策略的配置</li>
<li>一旦配置了<code>catalina.policy</code> 文件，便可以使用<code>SecurityManager</code>和<code>–security</code>选项启Tomcat。</li>
</ul>
<p>注意事项：</p>
<ul>
<li>因为基本上所有的权限类型（比如访问单个文件和目录或Java包）都应该根据每个应用程序进行单独配置，所以这会大大增加操作成本。另外，限制过于严格的策略文件会影响应用程序的功能。</li>
</ul>
<h3 id="访问Java包控制"><a href="#访问Java包控制" class="headerlink" title="访问Java包控制"></a>访问Java包控制</h3><p>描述：Tomcat可限制对某些Java包的访问。如果检测到受限制的包被访问，将抛出安全异常。 对Java包做访问限制，打开 <code>$CATALINA_BASE/conf/catalina.properties</code> 文件并添加不允许访问的包至<code>package.access</code>列表。</p>
<p>分析Java import可以列出哪些应用程序需要哪些包。在Unix系统上，可以使用以下例子来实现：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep –R import <span class="variable">$&#123;tomcat_home&#125;</span>/webapps/WEBAPP</span><br></pre></td></tr></table></figure>





<h2 id="Server-xml生产配置实例"><a href="#Server-xml生产配置实例" class="headerlink" title="Server.xml生产配置实例"></a>Server.xml生产配置实例</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 修改Connector元素 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Connector</span> <span class="attr">executor</span>=<span class="string">&quot;tomcatThreadPool&quot;</span> </span></span><br><span class="line"><span class="tag">  <span class="attr">port</span>=<span class="string">&quot;8080&quot;</span> </span></span><br><span class="line"><span class="tag">  <span class="attr">protocol</span>=<span class="string">&quot;org.apache.coyote.http11.Http11NioProtocol&quot;</span></span></span><br><span class="line"><span class="tag"></span></span><br><span class="line"><span class="tag">  <span class="attr">address</span>=<span class="string">&quot;127.0.0.1&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">acceptCount</span>=<span class="string">&quot;1000&quot;</span></span></span><br><span class="line"><span class="tag"></span></span><br><span class="line"><span class="tag">  <span class="attr">connectionTimeout</span>=<span class="string">&quot;20000&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">compression</span>=<span class="string">&quot;on&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">compressionMinSize</span>=<span class="string">&quot;2048&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">compressableMimeType</span>=<span class="string">&quot;text/html,text/xml,text/javascript,text/css,text/plain,image/gif,image/jpg,image/png&quot;</span></span></span><br><span class="line"><span class="tag"></span></span><br><span class="line"><span class="tag">  <span class="attr">disableUploadTimeout</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag"></span></span><br><span class="line"><span class="tag">  <span class="attr">enableLookups</span>=<span class="string">&quot;false&quot;</span></span></span><br><span class="line"><span class="tag"></span></span><br><span class="line"><span class="tag">  <span class="attr">maxThreads</span>=<span class="string">&quot;1000&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">minSpareThreads</span>=<span class="string">&quot;100&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">maxSpareThreads</span>=<span class="string">&quot;200&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">maxKeepAliveRequests</span>=<span class="string">&quot;1&quot;</span></span></span><br><span class="line"><span class="tag">  </span></span><br><span class="line"><span class="tag">  <span class="attr">redirectPort</span>=<span class="string">&quot;8443&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">server</span>=<span class="string">&quot;SecWAF/1.9&quot;</span></span></span><br><span class="line"><span class="tag"></span></span><br><span class="line"><span class="tag">  <span class="attr">URIEncoding</span>=<span class="string">&quot;UTF-8&quot;</span></span></span><br><span class="line"><span class="tag">  /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- </span></span><br><span class="line"><span class="comment"># 参数说明：</span></span><br><span class="line"><span class="comment">  protocol : 协议调整工作模式为Nio (org.apache.coyote.http11.Http11Nio)</span></span><br><span class="line"><span class="comment">  port : 绑定监听端口</span></span><br><span class="line"><span class="comment">  redirectPort ：重定向端口</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  address : 绑定监听地址</span></span><br><span class="line"><span class="comment">  acceptCount ：当同时连接的人数达到`maxThreads`参数设置的值时其还可以接收排队的连接数量，超过这个连接的则直接返回拒绝连接。在实际应用中如果想加大Tomcat的并发数，应该同时加大 acceptCount 和 maxThreads 的值。</span></span><br><span class="line"><span class="comment">  </span></span><br><span class="line"><span class="comment">  connectionTimeout : 连接超时时间单位毫秒,0代表不限制。</span></span><br><span class="line"><span class="comment">  compression ：启用压缩功能。</span></span><br><span class="line"><span class="comment">  compressionMinSize ：最小压缩大小单位Byte。</span></span><br><span class="line"><span class="comment">  compressableMimeType ：压缩的文件类型。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  disableUploadTimeout：禁用上传超时时间</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  enableLookups ：是否开启域名反查,一般设置为false来提高处理能力。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  maxThreads ：设置当前Tomcat的最大并发数,默认配置的最大请求数是150个,即同时能支持150个并发。</span></span><br><span class="line"><span class="comment">  minSpareThreads ：最小空闲线程数，设置当前Tomcat初始化时创建的线程数，默认值为25。</span></span><br><span class="line"><span class="comment">  maxSpareThreads ：最大空闲线程数，如果超过这个值会关闭无用的线程。</span></span><br><span class="line"><span class="comment">  maxKeepAliveRequests : 最大保持活动请求数,并且以必须设置tomcat的超时时间`connectionTimeout`,避免tomcat产生大量的TIME_WAIT连接。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  server : 设置server字段响应头;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  URIEncoding ：URI地址编码使用UTF-8</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br></pre></td></tr></table></figure>











</div></section><div id="reward-container"><span class="hty-icon-button button-glow" id="reward-button" title="打赏" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === &quot;none&quot;) ? &quot;block&quot; : &quot;none&quot;;"><span class="icon iconify" data-icon="ri:hand-coin-line"></span></span><div id="reward-comment">求打赏</div><div id="qr" style="display:none;"><div style="display:inline-block"><a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/michaelchan90/blog-imgbed/img/AliPay.png"><img loading="lazy" src="https://cdn.jsdelivr.net/gh/michaelchan90/blog-imgbed/img/AliPay.png" alt="支付宝" title="支付宝"></a><div><span style="color:#00A3EE"><span class="icon iconify" data-icon="ri:alipay-line"></span></span></div></div><div style="display:inline-block"><a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/michaelchan90/blog-imgbed/img/WechatPay.png"><img loading="lazy" src="https://cdn.jsdelivr.net/gh/michaelchan90/blog-imgbed/img/WechatPay.png" alt="微信支付" title="微信支付"></a><div><span style="color:#2DC100"><span class="icon iconify" data-icon="ri:wechat-pay-line"></span></span></div></div></div></div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>Michael Chan</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="http://michaelchan90.github.io/2023/03/01/Tomcat%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA/" title="tomcat安全加固">http://michaelchan90.github.io/2023/03/01/Tomcat%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>本博客所有文章除特别声明外，均默认采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 "><span class="icon iconify" data-icon="ri:creative-commons-line"></span><span class="icon iconify" data-icon="ri:creative-commons-by-line"></span><span class="icon iconify" data-icon="ri:creative-commons-nc-line"></span><span class="icon iconify" data-icon="ri:creative-commons-sa-line"></span></a> 许可协议。</li></ul><script>document.addEventListener('copy', function (event) {
  const clipboardData = event.clipboardData || window.clipboardData;
  if (!clipboardData) { return; }
  const text = window.getSelection().toString();
  if (text) {
    event.preventDefault();
    clipboardData.setData('text/plain', text + '\n\n本文作者：Michael Chan\n本文链接：http://michaelchan90.github.io/2023/03/01/Tomcat%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA/\n版权声明：本博客所有文章除特别声明外，均默认采用 CC BY-NC-SA 4.0 许可协议。');
  }
});</script></article><div class="post-nav"><div class="post-nav-item"><a class="post-nav-prev" href="/2023/03/02/Tomcat%E4%B8%AD%E7%9A%84catalina.out%E6%8C%89%E6%97%A5%E6%9C%9F%E8%BE%93%E5%87%BA%E5%88%B0%E6%96%87%E4%BB%B6/" rel="prev" title="Tomcat中catalina.out按日期输出到文件"><span class="icon iconify" data-icon="ri:arrow-left-s-line"></span><span class="post-nav-text">Tomcat中catalina.out按日期输出到文件</span></a></div><div class="post-nav-item"><a class="post-nav-next" href="/2023/02/27/Redis7.0%E5%AE%89%E8%A3%85/" rel="next" title="Redis7.0安装"><span class="post-nav-text">Redis7.0安装</span><span class="icon iconify" data-icon="ri:arrow-right-s-line"></span></a></div></div></div><div class="hty-card" id="comment"><div class="comment-tooltip text-center"><span>若您想及时得到回复提醒，建议跳转 GitHub Issues 评论。</span><br></div></div></main><footer class="sidebar-translate" id="footer"><div class="beian"><a rel="noopener" href="https://beian.miit.gov.cn/" target="_blank">京ICP备xxxxxxxx号</a></div><div class="copyright"><span>&copy; 2023 </span><span class="with-love" id="animate" title="星无尘的赞助者"><span class="icon iconify" data-icon="ri:cloud-line"></span></span><span class="author"> Michael Chan</span></div><div class="live-time"><span>本博客已萌萌哒地运行</span><span id="display_live_time"></span><span class="moe-text">(●'◡'●)</span><script>function blog_live_time() {
  setTimeout(blog_live_time, 1000);
  const start = new Date('2023-01-01T00:00:00');
  const now = new Date();
  const timeDiff = (now.getTime() - start.getTime());
  const msPerMinute = 60 * 1000;
  const msPerHour = 60 * msPerMinute;
  const msPerDay = 24 * msPerHour;
  const passDay = Math.floor(timeDiff / msPerDay);
  const passHour = Math.floor((timeDiff % msPerDay) / 60 / 60 / 1000);
  const passMinute = Math.floor((timeDiff % msPerHour) / 60 / 1000);
  const passSecond = Math.floor((timeDiff % msPerMinute) / 1000);
  display_live_time.innerHTML = ` ${passDay} 天 ${passHour} 小时 ${passMinute} 分 ${passSecond} 秒`;
}
blog_live_time();
</script></div><div id="busuanzi"><span id="busuanzi_container_site_uv" title="总访客量"><span><span class="icon iconify" data-icon="ri:user-line"></span></span><span id="busuanzi_value_site_uv"></span></span><span class="footer-separator">|</span><span id="busuanzi_container_site_pv" title="总访问量"><span><span class="icon iconify" data-icon="ri:eye-line"></span></span><span id="busuanzi_value_site_pv"></span></span><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></footer></div><a class="hty-icon-button" id="back-to-top" aria-label="back-to-top" href="#"><span class="icon iconify" data-icon="ri:arrow-up-s-line"></span><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#0078E7" stroke-width="2" stroke-linecap="round"></circle></svg></a><a class="popup-trigger hty-icon-button icon-search" id="search" href="javascript:;" title="搜索"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:search-line"></span></span></a><script>window.addEventListener("DOMContentLoaded", () => {
  // Handle and trigger popup window
  document.querySelector(".popup-trigger").addEventListener("click", () => {
    document.querySelector(".popup").classList.add("show");
    setTimeout(() => {
      document.querySelector(".search-input").focus();
    }, 100);
  });

  // Monitor main search box
  const onPopupClose = () => {
    document.querySelector(".popup").classList.remove("show");
  };

  document.querySelector(".popup-btn-close").addEventListener("click", () => {
    onPopupClose();
  });

  window.addEventListener("keyup", event => {
    if (event.key === "Escape") {
      onPopupClose();
    }
  });
});
</script><script src="https://fastly.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js"></script><script src="/js/search/local-search.js" defer type="module"></script><div class="popup search-popup"><div class="search-header"><span class="popup-btn-close close-icon hty-icon-button"><span class="icon iconify" data-icon="ri:close-line"></span></span></div><div class="search-input-container"><input class="search-input" id="local-search-input" type="text" placeholder="搜索..." value=""></div><div class="search-result-container"></div></div><script>function initMourn() {
  const date = new Date();
  const today = (date.getMonth() + 1) + "-" + date.getDate()
  const mourn_days = ["4-4","9-18","12-13"]
  if (mourn_days.includes(today)) {
    document.documentElement.style.filter = "grayscale(1)";
  }
}
initMourn();</script></body></html>